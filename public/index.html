<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Private Chat</title>

<script src="/socket.io/socket.io.js"></script>

<style>

/* ================= THEME ================= */

:root{
  --bg:#0f2027;
  --card:#121212;
  --head:#1f1f1f;
  --input:#2c2c2c;
  --me:#25d366;
  --other:#2a2a2a;
  --text:white;
}

.light{
  --bg:#f2f2f2;
  --card:#ffffff;
  --head:#eeeeee;
  --input:#dddddd;
  --me:#00a884;
  --other:#cccccc;
  --text:black;
}

/* ================= BODY ================= */

body{
  margin:0;
  min-height:100vh;
  font-family:Arial;
  background:var(--bg);
  color:var(--text);

  display:flex;
  justify-content:center;
  align-items:center;
}


/* ================= LOGIN ================= */

.box{
  width:90%;
  max-width:350px;
  background:var(--card);
  padding:25px;
  border-radius:15px;
  text-align:center;
  box-shadow:0 0 20px rgba(0,0,0,.6);
}

input{
  width:100%;
  padding:10px;
  margin:10px 0;
  border:none;
  border-radius:8px;
  background:var(--input);
  color:var(--text);
}

button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:8px;
  background:var(--me);
  cursor:pointer;
  font-size:15px;
}


/* ================= CHAT ================= */

#chatBox{
  display:none;
  width:95%;
  max-width:420px;
  height:85vh;
  background:var(--card);
  border-radius:15px;
  flex-direction:column;
}


/* ================= HEADER ================= */

#chatHeader{
  background:var(--head);
  padding:10px;

  display:flex;
  justify-content:space-between;
  align-items:center;

  position:relative;
}

#menuBtn{
  background:none;
  border:none;
  font-size:22px;
  cursor:pointer;
  color:var(--text);
}


/* MENU */

#menu{
  display:none;

  position:absolute;
  top:45px;
  right:10px;

  background:var(--card);
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.6);

  width:160px;
  z-index:100;
}

.menuItem{
  padding:10px;
  cursor:pointer;
  border-bottom:1px solid #333;
}

.menuItem:last-child{
  border-bottom:none;
}

.menuItem:hover{
  background:rgba(255,255,255,.1);
}


/* ================= MESSAGES ================= */

#messages{
  flex:1;
  padding:10px;
  overflow-y:auto;
  background:#0d0d0d;
}

.msg{
  max-width:70%;
  padding:8px;
  margin:5px 0;
  border-radius:10px;
}

.me{
  background:var(--me);
  color:black;
  margin-left:auto;
}

.other{
  background:var(--other);
}

.status{
  font-size:10px;
  text-align:right;
  opacity:.7;
}


/* ================= INPUT ================= */

#inputBox{
  display:flex;
  padding:10px;
  background:var(--head);
}

#msgInput{
  flex:1;
  border-radius:20px;
}

#sendBtn{
  width:40px;
  height:40px;
  border-radius:50%;
}


/* ================= ADMIN ================= */

#adminBox{
  display:none;
  width:95%;
  max-width:700px;
  background:var(--card);
  padding:20px;
  border-radius:15px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th,td{
  border:1px solid #444;
  padding:5px;
  text-align:center;
}

.delBtn{
  background:red;
  color:white;
  padding:5px;
  border:none;
  cursor:pointer;
}


/* ================= MOBILE ================= */

@media(max-width:768px){

  #chatBox{
    width:100%;
    height:100vh;
    border-radius:0;
  }

}

</style>
</head>

<body>


<!-- USER LOGIN -->

<div id="loginBox" class="box">

  <h3>User Login</h3>

  <input id="password" type="password" placeholder="Password">

  <button onclick="joinChat()">Join</button>

</div>


<!-- ADMIN LOGIN -->

<div id="adminLogin" class="box" style="display:none;">

  <h3>Admin Login</h3>

  <input id="adminPass" type="password" placeholder="Admin Password">

  <button onclick="adminLogin()">Login</button>

</div>


<!-- CHAT -->

<div id="chatBox">

  <div id="chatHeader">

    <div>
      üí¨ Chat
      <div id="online">0 online</div>
      <div id="status" style="font-size:11px;opacity:.7;"></div>
    </div>


    <!-- MENU BUTTON -->
    <button id="menuBtn" onclick="toggleMenu()">‚ãÆ</button>


    <!-- MENU -->
    <div id="menu">

      <div class="menuItem" onclick="toggleMode()">
        üåô Dark / Light
      </div>

      <div class="menuItem" onclick="openAdmin()">
        üîê Admin Panel
      </div>

    </div>


  </div>


  <div id="messages"></div>


  <div id="inputBox">

    <input id="msgInput" placeholder="Message">

    <button id="sendBtn" onclick="sendMsg()">‚û§</button>

  </div>

</div>


<!-- ADMIN PANEL -->

<div id="adminBox">

  <h3>Admin Dashboard</h3>

  <p>Online: <span id="adminUsers">0</span></p>

  <h4>Messages</h4>

  <table id="msgTable"></table>

  <h4>IP Scans</h4>

  <table id="scanTable"></table>

  <br>

  <button onclick="location.reload()">Logout</button>

</div>


<script>

const socket = io();

let typingTimer;


/* ================= USER ================= */

function joinChat(){

  if(!password.value) return alert("Enter password");

  socket.emit("join",password.value);

}

socket.on("joinError",m=>alert(m));

socket.on("joinSuccess",()=>{

  loginBox.style.display="none";
  chatBox.style.display="flex";

});


socket.on("onlineCount",n=>{

  online.innerText=n+" online";

});


socket.on("oldMessages",msgs=>{

  msgs.forEach(m=>{
    showMsg(m.msg,false,m._id,m.seen);
  });

});


socket.on("message",m=>{

  showMsg(m.msg,false,m._id,m.seen);

});


socket.on("seen",id=>{

  const s=document.getElementById("s"+id);
  if(s) s.innerText="Seen";

});


/* ================= TYPING ================= */

msgInput.addEventListener("input",()=>{

  socket.emit("typing");

  clearTimeout(typingTimer);

  typingTimer=setTimeout(()=>{
    socket.emit("stopTyping");
  },800);

});


socket.on("typing",()=>{

  status.innerText="Typing...";

});


socket.on("stopTyping",()=>{

  status.innerText="";

});


/* ================= LAST SEEN ================= */

socket.on("lastSeen",time=>{

  status.innerText="Last seen at "+time;

});


function showMsg(msg,self,id,seen){

  const d=document.createElement("div");

  d.className="msg "+(self?"me":"other");

  d.innerHTML=`
    ${msg}
    <div class="status" id="s${id}">
      ${self?(seen?"Seen":"Delivered"):""}
    </div>
  `;

  messages.appendChild(d);

  messages.scrollTop=messages.scrollHeight;

  if(!self && id){
    socket.emit("seen",id);
  }

}


function sendMsg(){

  if(!msgInput.value.trim()) return;

  socket.emit("message",msgInput.value);

  msgInput.value="";

}


/* ================= MENU ================= */

function toggleMenu(){

  menu.style.display =
    menu.style.display==="block" ? "none" : "block";

}


/* CLOSE MENU */

document.addEventListener("click",e=>{

  if(!e.target.closest("#menuBtn") &&
     !e.target.closest("#menu")){

    menu.style.display="none";
  }

});


/* ================= ADMIN ================= */

function openAdmin(){

  chatBox.style.display="none";
  adminLogin.style.display="block";

  menu.style.display="none";

}


function adminLogin(){

  fetch("/admin-login",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      password:adminPass.value
    })
  })

  .then(r=>r.json())
  .then(d=>{

    if(!d.success){
      alert("Wrong Admin Password");
      return;
    }

    adminLogin.style.display="none";
    adminBox.style.display="block";

    loadAdmin();

  });

}


function loadAdmin(){

  fetch("/admin-data")
  .then(r=>r.json())
  .then(d=>{

    adminUsers.innerText=d.users;


    msgTable.innerHTML=
    "<tr><th>Msg</th><th>Seen</th><th>Del</th></tr>";

    d.messages.forEach(m=>{

      msgTable.innerHTML+=`
        <tr>
          <td>${m.msg}</td>
          <td>${m.seen}</td>
          <td>
            <button class="delBtn"
            onclick="delMsg('${m._id}')">X</button>
          </td>
        </tr>
      `;

    });


    scanTable.innerHTML=
    "<tr><th>IP</th><th>Country</th><th>City</th></tr>";

    d.scans.forEach(s=>{

      scanTable.innerHTML+=`
        <tr>
          <td>${s.ip}</td>
          <td>${s.country}</td>
          <td>${s.city}</td>
        </tr>
      `;

    });

  });

}


function delMsg(id){

  fetch("/delete/"+id,{
    method:"DELETE"
  })
  .then(()=>loadAdmin());

}


/* ================= MODE ================= */

function toggleMode(){

  document.body.classList.toggle("light");

  menu.style.display="none";

}

</script>

</body>
</html>

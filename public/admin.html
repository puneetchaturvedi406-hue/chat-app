<!DOCTYPE html>
<html>
<head>

<title>QuietTalks Admin Panel</title>

<style>
body {
  font-family: Arial;
  background: #111;
  color: white;
  padding: 20px;
}

input, button {
  padding: 8px;
  margin: 5px;
  border-radius: 5px;
  border: none;
}

button{
  background: #25d366;
  cursor: pointer;
  font-weight: bold;
}

.box {
  background: #222;
  padding: 15px;
  margin: 10px 0;
  border-radius: 8px;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  border: 1px solid gray;
  padding: 8px;
  text-align: center;
  font-size: 13px;
}

th {
  background: #333;
}

#panel {
  display: none;
}

.delBtn{
  background: red;
  color: white;
  padding: 4px 8px;
  cursor: pointer;
}
</style>

</head>

<body>

<h2>ğŸ” QuietTalks Admin Panel</h2>

<!-- LOGIN -->
<div id="login">
  <input type="password" id="pass" placeholder="Admin Password">
  <br>
  <button onclick="login()">Login</button>
</div>

<!-- DASHBOARD -->
<div id="panel">

<h3>ğŸ“Š Dashboard</h3>
<button onclick="loadData()">ğŸ”„ Refresh</button>

<div class="box">
  <h4>ğŸ‘¥ Users</h4>
  <p id="users">0</p>
</div>

<div class="box">
  <h4>ğŸ’¬ Messages</h4>
  <table>
    <thead>
      <tr>
        <th>Message</th>
        <th>Seen</th>
        <th>Status</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody id="msgTable"></tbody>
  </table>
</div>

<div class="box">
  <h4>ğŸŒ Visitor History</h4>
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>IP</th>
        <th>Country</th>
        <th>City</th>
      </tr>
    </thead>
    <tbody id="scanTable"></tbody>
  </table>
</div>

</div>

<script>

/* ================= LOGIN ================= */
async function login() {

  const pass = document.getElementById("pass").value;

  if(!pass){
    alert("Enter password");
    return;
  }

  const res = await fetch("/admin-login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ password: pass })
  });

  const data = await res.json();

  if(data.success){
    document.getElementById("login").style.display = "none";
    document.getElementById("panel").style.display = "block";
    loadData();
  }else{
    alert("Wrong Password âŒ");
  }
}

/* ================= LOAD DATA ================= */
async function loadData(){

  try{
    const res = await fetch("/admin-data");

    if(!res.ok){
      alert("Session expired âŒ");
      location.reload();
      return;
    }

    const data = await res.json();

    // USERS
    document.getElementById("users").innerText = data.users;

    // MESSAGES
    let msgHtml = "";
    data.messages.forEach(m => {
      msgHtml += `
        <tr>
          <td>${m.msg}</td>
          <td>${m.seen ? "Yes" : "No"}</td>
          <td>${m.deleted ? "Deleted" : "Active"}</td>
          <td>
            ${
              !m.deleted
              ? `<button class="delBtn" onclick="delMsg('${m._id}')">X</button>`
              : "-"
            }
          </td>
        </tr>
      `;
    });
    document.getElementById("msgTable").innerHTML = msgHtml;

    // SCANS
    let scanHtml = "";
    data.scans.forEach(s => {
      const time = new Date(s.time).toLocaleString();
      scanHtml += `
        <tr>
          <td>${time}</td>
          <td>${s.ip}</td>
          <td>${s.country}</td>
          <td>${s.city}</td>
        </tr>
      `;
    });
    document.getElementById("scanTable").innerHTML = scanHtml;

  }catch(err){
    console.log(err);
    alert("Failed to load âŒ");
  }
}

/* ================= DELETE ================= */
async function delMsg(id){
  if(!confirm("Delete?")) return;
  await fetch("/delete/"+id,{ method:"DELETE" });
  loadData();
}

</script>

</body>
</html>
